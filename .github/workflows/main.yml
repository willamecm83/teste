name: Release on PR merge

on:
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: write   # necessário para criar tags e releases
  issues: write     # necessário para criar labels via API
  pull-requests: read # para ler labels dos PRs

jobs:
  create-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Ensure labels exist (major, minor, patch)
        run: |
          for label in major minor patch; do
            echo "Verificando label: $label"
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/labels/$label)

            if [ "$RESPONSE" -eq 404 ]; then
              echo "Label $label não existe. Criando..."
              if [ "$label" = "major" ]; then COLOR="d73a4a"; DESC="Incrementa versão major"; fi
              if [ "$label" = "minor" ]; then COLOR="fbca04"; DESC="Incrementa versão minor"; fi
              if [ "$label" = "patch" ]; then COLOR="0e8a16"; DESC="Incrementa versão patch"; fi

              curl -s -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/labels \
                -d "{\"name\":\"$label\",\"color\":\"$COLOR\",\"description\":\"$DESC\"}"
            else
              echo "Label $label já existe."
            fi
          done

      - name: Get latest tag
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "Última tag encontrada: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Decide bump type from labels
        id: bump_type
        run: |
          LABELS="${{ toJson(github.event.pull_request.labels) }}"
          echo "Labels do PR: $LABELS"

          if echo "$LABELS" | grep -q '"name":"major"'; then
            echo "bump=major" >> $GI
